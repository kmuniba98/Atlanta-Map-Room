<!DOCTYPE html>
<html>

<head>
  <meta charset=utf-8 />
  <title>Projector</title>
  <script src='https://api.mapbox.com/mapbox-gl-js/v0.46.0/mapbox-gl.js'></script>
  <script src="/socket.io/socket.io.js"></script>
  <link href='https://api.mapbox.com/mapbox-gl-js/v0.46.0/mapbox-gl.css' rel='stylesheet' />
  <style>
    body { margin:0; padding:0; }
    #map { position:absolute; top:0; bottom:0; width:75%;}
  </style>
</head>

<body>
  <style>
      @import url('https://fonts.googleapis.com/css?family=PT+Mono|PT+Serif');

        h6 {
            font-family: 'PT Mono', monospace;
            padding-left: 80%;
            line-height: 25px;
            font-size: 20px;
            padding-bottom: 17px;
        }

        h5 {
            font-family: 'PT Serif', serif;;
            padding-left: 80%;
            line-height: 20px;
            font-size: 24px;
        }
        span {
          padding-top: 0px;
          padding-bottom: 0px;
          margin-bottom: 0px;
          margin-top: 0px;
          line-height: 10px;
        }
  </style>

  <div id='map'></div>
  <div id="point_text" style="max-height:100%">
    <h5 id="address_text">Address</h5>
    <h6 id="address">Address</h6><span></span>
    <h5 id="assess_text_10">2010 Assessment</h5>
    <h6 id="tenAssess">2010 Assessment</h6><span></span>
    <h5 id="assess_text_17">2017 Assessment</h5>
    <h6 id="sevenAssess">2017 Assessment</h6><span></span>
    <h5 id="assess_change_text">Assessment Percent Change</h5>
    <h6 id="assess_change">Assessment Percent Change</h6><span></span>
    <h5 id="appr_text_10">2010 Appraisal</h5>
    <h6 id="tenAppr">2010 Appraisal</h6><span></span>
    <h5 id="appr_text_17">2017 Appraisal</h5>
    <h6 id="sevenAppr">2017 Appraisal</h6><span></span>
    <h5 id="appr_change_text">Appraisal Percent Change</h5>
    <h6 id="appr_change">Appraisal Percent Change</h6>
  </div>
  <script>

  var leftLong, rightLong, lowerLat, upperLat
  var curBearing = 0
  var curZoom = 1
  var curCenter = [1,1]
  var curGeoCoords, curActiveRectangle, curEndCenters
  var leftCenter = {lng:-84.3880,lat:33.7490}
  var rightCenter = {lng:-82.3880,lat:33.7490}
  var rc, lc
  var SPoints = [];
  var socket = io('http://maproom.lmc.gatech.edu:8080');

  mapboxgl.accessToken = 'pk.eyJ1IjoibW9kZXJubG92ZWxhY2UiLCJhIjoiY2pmY24zNzhmM2VmaTJ4cDRlNmVoa24wdCJ9.7GBTZc76YFp947kU7A14Gg';

  socket.on('pushMapUpdate', function(data) {
    console.log("Controller changed, updating map...");

    curCenter = data['center'];
    curZoom = data['zoom'];
    curBearing = data['bearing'];
    curGeoCoords = data['geoCoordinates'];
    curActiveRectangle = data['activeRectangle'];
    curEndCenters = data['endCenters']

    leftCenter = curEndCenters.lc
    rightCenter = curEndCenters.rc

    console.log(curBearing + ", " + JSON.stringify(leftCenter) + ", " + JSON.stringify(rightCenter))

    map.easeTo({center: curCenter, zoom:(curZoom + 2.7), bearing:curBearing})
  });

  socket.on('pushSensorUpdate', function(data) {

    console.log("New sensor reading: " + data.distance)

    var start = 1780 //1840
    var end = 5080

    projRatio = ((data.distance - start) / (end-start))

    projLat = leftCenter.lat + (projRatio * (rightCenter.lat - leftCenter.lat))
    projLong = leftCenter.lng + (projRatio * (rightCenter.lng - leftCenter.lng))

    console.log(projLat + ", " + projLong)

    map.easeTo({center: {lng: projLong, lat:projLat}, zoom:(curZoom + 2.7), bearing:curBearing})

  });

  socket.on('pushHideLayer', function(data){
    var hiddenLayer = data['clickedLayer'];
    map.setLayoutProperty(hiddenLayer, 'visibility', 'none');
  });

  socket.on('pushShowLayer', function(data){
    var shownLayer = data['clickedLayer'];
    map.setLayoutProperty(shownLayer, 'visibility', 'visible');
  });
  socket.on('pushChangeSize', function(data){ // for toggleRectangle

  });

    //Added by Annabel - manage highlighted points
  socket.on('removeFromProjector', function(data){
    console.log(index);
    var index = data; //SPoints.indexOf(map.queryRenderedFeatures({layers:['Tax Assessment']})[parseInt(data['removeMarker'])].properties.ID);
    if (index > -1){
        SPoints.splice(index, 1);
    }
    if (SPoints.length > 0){
      var filter2 = ['match', ['get', 'ID'], SPoints, true, false];
      map.setFilter("place-highlight", filter2);
    }
    else{
      var filter1 = ['==', 'ID', -1];
      map.setFilter("place-highlight", filter1);
    };
  });

  socket.on('addToProjector', function(data) {
    var current = data; //map.queryRenderedFeatures({layers:['Tax Assessment']})[parseInt(data['newMarker'])];
    SPoints = [current.properties.ID];
    var filter = ['match', ['get', 'ID'], SPoints, true, false];
    map.setFilter("place-highlight", filter);
    console.log(current.properties.ID);
    console.log(current);

    if (current.properties['2010_assessment'] > 100){
        console.log(current.properties['2010_assessment'].toString().replace(/(\d)(?=(\d\d\d)+(?!\d))/g, "$1,"));
        console.log(current.properties['2010_assessment'].toLocaleString());
    }

    document.getElementById("address").innerHTML = current.properties['SITUS'];
    document.getElementById("tenAssess").innerHTML = ("$" + current.properties['2010_assessment'].toString().replace(/(\d)(?=(\d\d\d)+(?!\d))/g, "$1,"));
    document.getElementById("sevenAssess").innerHTML = ("$" + current.properties['2017_assessment'].toString().replace(/(\d)(?=(\d\d\d)+(?!\d))/g, "$1,"));
    document.getElementById("assess_change").innerHTML = (current.properties['assess_change'].toLocaleString() +"%");
    document.getElementById("tenAppr").innerHTML = ("$" + current.properties['2010_appr'].toString().replace(/(\d)(?=(\d\d\d)+(?!\d))/g, "$1,"));
    document.getElementById("sevenAppr").innerHTML = ("$" + current.properties['2017_appr'].toString().replace(/(\d)(?=(\d\d\d)+(?!\d))/g, "$1,"));
    document.getElementById("appr_change").innerHTML = (current.properties['appr_change'] + "%");

  });




  var map = new mapboxgl.Map({
    container: 'map', // container id
    center: [-84.27173029708604, 33.76777287243536],
    style:'mapbox://styles/modernlovelace/cjiw122ea18z12so7ijbzd98v'
  });

  map.on('load', function () {
      // beltline layer
      map.addSource('beltline', {
          type: 'vector',
          url: 'mapbox://modernlovelace.9bd0nhcf'
      });
      map.addLayer({
          'id': 'beltline',
          'type': 'line',
          'source': 'beltline',
          'source-layer': 'Beltline_Weave-a4j3wv',
          'layout': {
              'visibility': 'visible',
              'line-join': 'round',
              'line-cap': 'round'
          },
          'paint': {
              'line-color': 'yellow green',
              'line-width': 8
          }
      });
      // tax layer
      map.addSource('Tax Assessment', {
          type: 'vector',
          url: 'mapbox://modernlovelace.8yz9usdz'
      });
      map.addLayer({
          'id': 'place-highlight',
          'type': 'circle',
          'source': 'Tax Assessment',
          'source-layer': 'AllPointsGeoJSONFinal07-13-7hq681',
          'paint': {
            'circle-color': '#FADA5E',
            'circle-radius': 20,
            'circle-opacity': .5,
          },
          'filter': ['==', 'ID', -1]
      });
      map.addLayer({
          'id': 'Tax Assessment',
          'type': 'circle',
          'source': 'Tax Assessment',
          'interactive': true,
          "layout": {
                    "text-font": "Open Sans Semibold, Arial Unicode MS Bold",
                    "text-offset": [0, 0.6],
                    "text-anchor": "top"
                  },
          'layout': {
              'visibility': 'none'
          },
          'paint': {
              'circle-radius': 3,
              'circle-color': [
                  "rgb",
                  ["get", "Red"],
                  ["get", "Green"],
                  ["get", "Blue"]
              ]
          },
          'source-layer': 'AllPointsGeoJSONFinal07-13-7hq681'
      });
  });

  map.addControl(new mapboxgl.FullscreenControl());


  </script>

</body>
</html>
