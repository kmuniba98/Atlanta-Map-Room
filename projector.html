<!DOCTYPE html>
<html>

<head>
  <meta charset=utf-8 />
  <script src='https://api.mapbox.com/mapbox-gl-js/v0.46.0/mapbox-gl.js'></script>
  <script src="/socket.io/socket.io.js"></script>
  <link href='https://api.mapbox.com/mapbox-gl-js/v0.46.0/mapbox-gl.css' rel='stylesheet' />
  <style>
    body { margin:0; padding:0; }
    #map { position:absolute; top:0; bottom:0; width:75%;}
  </style>
</head>

<body>
  <style>
  </style>

  <div id='map'></div>

  <script>

  var leftLong, rightLong, lowerLat, upperLat, mapBearing, mapZoom, mapCenter

  var socket = io('http://143.215.119.183:8080');

  socket.on('pushMapUpdate', function(data) {
    console.log("Controller changed, updating map...");

    mapCenter = data['center'];
    mapZoom = data['zoom'];
    mapBearing = data['bearing'];

    console.log(data['bounds']);
    console.log(data['projectorPosition'])

    leftLong = data['leftLong'];
    rightLong = data['rightLong'];
    lowerLat = data['lowerLat'];
    upperLat = data['upperLat'];

    //map.easeTo({center: newCenter, zoom:newZoom, bearing:newBearing})
  });

  socket.on('pushSensorUpdate', function(data) {
    console.log("New sensor reading: " + data.distance)

    var start = 3750
    var end = 5350

    curRatio = ((data.distance) / (end-start))

    curLat = lowerLat + (curRatio * (upperLat - lowerLat))
    curLong = leftLong + (curRatio * (rightLong - leftLong))

    console.log("Moving to " + curLat + ", " + curLong)

    //map.easeTo({center: newCenter, zoom:mapZoom, bearing:mapBearing})

  });

  socket.on('pushHideLayer', function(data){
    var hiddenLayer = data['clickedLayer'];
    map.setLayoutProperty(hiddenLayer, 'visibility', 'none');
  });

  socket.on('pushShowLayer', function(data){
    var shownLayer = data['clickedLayer'];
    map.setLayoutProperty(shownLayer, 'visibility', 'visible');
  });

  mapboxgl.accessToken = 'pk.eyJ1IjoibW9kZXJubG92ZWxhY2UiLCJhIjoiY2pmY24zNzhmM2VmaTJ4cDRlNmVoa24wdCJ9.7GBTZc76YFp947kU7A14Gg';

  var map = new mapboxgl.Map({
    container: 'map', // container id
    style:'mapbox://styles/modernlovelace/cjiw122ea18z12so7ijbzd98v'
  });

  map.on('load', function () {
      // permit layer
      map.addSource('permits', {
          type: 'vector',
          url: 'mapbox://modernlovelace.cjiqeva5803dtfrrvg9g78mzz-7xosm'
      });
      map.addLayer({
          'id': 'permits',
          'type': 'circle',
          'source': 'permits',
          'layout': {
              'visibility': 'visible'
          },
          'paint': {
              'circle-radius': 8,
              'circle-color': 'blue'
          },
          'source-layer': 'commercial_land_development_2017'
      });
      // beltline layer
      map.addSource('beltline', {
          type: 'vector',
          url: 'mapbox://modernlovelace.9bd0nhcf'
      });
      map.addLayer({
          'id': 'beltline',
          'type': 'line',
          'source': 'beltline',
          'source-layer': 'Beltline_Weave-a4j3wv',
          'layout': {
              'visibility': 'visible',
              'line-join': 'round',
              'line-cap': 'round'
          },
          'paint': {
              'line-color': 'purple',
              'line-width': 8
          }
      });
  });

  map.addControl(new mapboxgl.FullscreenControl());


  </script>

</body>
</html>
