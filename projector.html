<!DOCTYPE html>
<html>

<head>
  <meta charset=utf-8 />
  <script src='https://api.mapbox.com/mapbox-gl-js/v0.46.0/mapbox-gl.js'></script>
  <script src="/socket.io/socket.io.js"></script>
  <link href='https://api.mapbox.com/mapbox-gl-js/v0.46.0/mapbox-gl.css' rel='stylesheet' />
  <style>
    body { margin:0; padding:0; }
    #map { position:absolute; top:0; bottom:0; width:75%;}
  </style>
</head>

<body>
  <style>
  </style>

  <div id='map'></div>

  <script>

  var socket = io('http://128.61.54.6:8080');

  var SPoints = [];

  socket.on('pushLocUpdate', function(data) {
    console.log("Controller changed...");

    var newCenter = data['center'];
    var newZoom = data['zoom'];
    var newBearing = data['bearing'];

    map.easeTo({center: newCenter, zoom:newZoom, bearing:newBearing})
  })

  socket.on('pushHideLayer', function(data){
    var hiddenLayer = data['clickedLayer'];
    map.setLayoutProperty(hiddenLayer, 'visibility', 'none');
  });
  socket.on('pushShowLayer', function(data){
    var shownLayer = data['clickedLayer'];
    map.setLayoutProperty(shownLayer, 'visibility', 'visible');
  });
  socket.on('pushChangeSize', function(data){ // for toggleRectangle

  });

    //Added by Annabel - manage highlighted points
  socket.on('removeMarker', function(data){
    var index = SPoints.indexOf(map.queryRenderedFeatures({layers:['Tax Assessment']})[parseInt(data['removeMarker'])].properties.ID);
    if (index > -1){
        SPoints.splice(index, 1);
    }
    if (SPoints.length > 0){
      var filter2 = ['match', ['get', 'ID'], SPoints, true, false];
      map.setFilter("place-highlight", filter2);
    }
    else{
      var filter1 = ['==', 'ID', -1];
      map.setFilter("place-highlight", filter1);
    };
  });

  socket.on('newMarker', function(data) {
    var current = map.queryRenderedFeatures({layers:['Tax Assessment']})[parseInt(data['newMarker'])];
    SPoints.unshift(current.properties.ID);
    var filter = ['match', ['get', 'ID'], SPoints, true, false];
    map.setFilter("place-highlight", filter);
  });

  mapboxgl.accessToken = 'pk.eyJ1IjoibW9kZXJubG92ZWxhY2UiLCJhIjoiY2pmY24zNzhmM2VmaTJ4cDRlNmVoa24wdCJ9.7GBTZc76YFp947kU7A14Gg';

  var map = new mapboxgl.Map({
    container: 'map', // container id
    style:'mapbox://styles/modernlovelace/cjiw122ea18z12so7ijbzd98v'
  });

  map.on('load', function () {
      // beltline layer
      map.addSource('beltline', {
          type: 'vector',
          url: 'mapbox://modernlovelace.9bd0nhcf'
      });
      map.addLayer({
          'id': 'beltline',
          'type': 'line',
          'source': 'beltline',
          'source-layer': 'Beltline_Weave-a4j3wv',
          'layout': {
              'visibility': 'visible',
              'line-join': 'round',
              'line-cap': 'round'
          },
          'paint': {
              'line-color': 'yellow green',
              'line-width': 8
          }
      });
      // tax layer
      map.addSource('Tax Assessment', {
          type: 'vector',
          url: 'mapbox://annabelrothschild.4lnspuic'
      });
      map.addLayer({
          'id': 'place-highlight',
          'type': 'circle',
          'source': 'Tax Assessment',
          'source-layer': 'AllPointsGeoJSON-12eyog',
          'paint': {
            'circle-color': '#FADA5E',
            'circle-radius': 20,
            'circle-opacity': .5,
          },
          'filter': ['==', 'ID', -1]
      });
      map.addLayer({
          'id': 'Tax Assessment',
          'type': 'circle',
          'source': 'Tax Assessment',
          'interactive': true,
          "layout": {
                    "text-font": "Open Sans Semibold, Arial Unicode MS Bold",
                    "text-offset": [0, 0.6],
                    "text-anchor": "top"
                  },
          'layout': {
              'visibility': 'none'
          },
          'paint': {
              'circle-radius': 3,
              'circle-color': [
                  "rgb",
                  ["get", "Red"],
                  ["get", "Green"],
                  ["get", "Blue"]
              ]
          },
          'source-layer': 'AllPointsGeoJSON-12eyog'
      });
  });

  map.addControl(new mapboxgl.FullscreenControl());


  </script>

</body>
</html>
