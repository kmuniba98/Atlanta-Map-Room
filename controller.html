<!DOCTYPE html>
<html>
<head>
  <meta charset=utf-8 />
  <title>Controller</title>
  <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
  <script src='https://api.mapbox.com/mapbox-gl-js/v0.46.0/mapbox-gl.js'></script>
  <script src="/socket.io/socket.io.js"></script>
  <link href='https://api.mapbox.com/mapbox-gl-js/v0.46.0/mapbox-gl.css' rel='stylesheet' />
  <style>
    body { margin:0; padding:0; }
    #map { position:absolute; top:0; bottom:0; width:100%; }
  </style>
</head>

<body>
  <style>

      #shortRect {
          width:50%;
          padding:10%;
          box-sizing: border-box;
          position:absolute;
          top:50%;
          left:50%;
          transform:translate(-50%,-50%);
          border:10px dotted red;
          opacity:0.5;
          pointer-events:none;
      }

      #longRect {
        width:50%;
        padding:25%;
        box-sizing: border-box;
        position:absolute;
        top:50%;
        left:50%;
        transform:translate(-50%,-50%);
        border:10px dotted red;
        opacity:0.5;

        pointer-events:none;
        display:none;
      }

      #changeRect {
        display: block;
        position: absolute;
        top: 10px;
        left: 10px;
        width: 200px;
        padding: 15px;
        border: none;
        border-radius: 3px;
        font: 'Open Sans', sans-serif;
        font-size: 18px;
        font-weight: bold;
        text-align: center;
        color: #fff;
        background: #ee8a65;
      }

      #projectButton {
          display: block;
          position: absolute;
          top: 10px;
          left: 225px;
          width: 120px;
          padding: 15px;
          border: none;
          border-radius: 3px;
          font: 'Open Sans', sans-serif;
          font-size: 18px;
          font-weight: bold;
          text-align: center;
          color: #fff;
          background: #2ECC71;
      }

      #menu {
          background: #fff;
          position: absolute;
          z-index: 1;
          top: 10px;
          right: 10px;
          border-radius: 3px;
          width: 175px;
          border: 1px solid rgba(0,0,0,0.4);
          font-family: 'Open Sans', sans-serif;
      }

      #menu a {
          font-size: 18px;
          color: #404040;
          display: block;
          margin: 0;
          padding: 0;
          padding: 10px;
          text-decoration: none;
          border-bottom: 1px solid rgba(0,0,0,0.25);
          text-align: center;
      }

      #menu a:last-child {
          border: none;
      }

      #menu a:hover {
          background-color: #f8f8f8;
          color: #404040;
      }

      #menu a.active {
          background-color: #3887be;
          color: #ffffff;
      }

      #menu a.active:hover {
          background: #3074a4;
      }

      .legend {
      background-color: #fff;
      border-radius: 3px;
      bottom: 30px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.10);
      font-size: 18px;
      font-family: 'Open Sans', sans-serif;
      padding: 15px;
      position: absolute;
      border: 1px solid rgba(0,0,0,0.4);
      right: 10px;
      z-index: 1;
      color: #404040;
      }

      .legend h4 {
          margin: 0 0 10px;
      }

      .legend div span {
          border-radius: 50%;
          display: inline-block;
          height: 10px;
          margin-right: 5px;
          width: 10px;
      }

  </style>

  <nav id="menu"></nav>
  <div id="map"></div>
  <canvas id="shortRect"></canvas>
  <canvas id="longRect"></canvas>
  <div id='state-legend' class='legend'>
      <h4>Percent Change:<br>2010 - 2017</h4>
      <div><span style='background-color: #ff0000 '></span>100</div>
      <div><span style='background-color: #A25626'></span>0</div>
      <div><span style='background-color: #000000'></span>-100</div>
      <div><span style='background-color: #0000FF'></span>Infinite</div>
  </div>
  <br/>
  <button id='changeRect'>Toggle Map Size</button>
  <button id='projectButton'>Project</button>

  <script>

  var SPoints = [];

  var socket = io('http://128.61.121.12:8080');

  socket.on('pushLocUpdate', function(data) {
    console.log("I UPDATED");
  });

  //Added by Annabel - manage highlighted points
  socket.on('removeMarker', function(data){
    var index = SPoints.indexOf(map.queryRenderedFeatures({layers:['Tax Assessment']})[parseInt(data['removeMarker'])].properties.ID);
    if (index > -1){
      SPoints.splice(index, 1);
    }
    if (SPoints.length > 0){
      var filter2 = ['match', ['get', 'ID'], SPoints, true, false];
      map.setFilter("place-highlight", filter2);
    }
    else{
      var filter1 = ['==', 'ID', -1];
      map.setFilter("place-highlight", filter1);
    };
  });

  socket.on('newMarker', function(data) {
    var current = map.queryRenderedFeatures({layers:['Tax Assessment']})[parseInt(data['newMarker'])];
    SPoints.unshift(current.properties.ID);
    var filter = ['match', ['get', 'ID'], SPoints, true, false];
    map.setFilter("place-highlight", filter);
  });


  mapboxgl.accessToken = 'pk.eyJ1IjoibW9kZXJubG92ZWxhY2UiLCJhIjoiY2pmY24zNzhmM2VmaTJ4cDRlNmVoa24wdCJ9.7GBTZc76YFp947kU7A14Gg';

  var map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/modernlovelace/cjiw122ea18z12so7ijbzd98v',
      zoom: 12,
      bearing: -90,
      center: [-84.3951, 33.7634],
      interactive: true
  });

  function getActiveRect(){
    var x = document.getElementById("shortRect");
    var y = document.getElementById("longRect");
    if (x.style.display === "none") { // long rectangle active
        return y;
    } else {                          // short rectangle active
        return x;
    }
  }

  // function to toggle rectangle
  function toggleRectangle() {
      var x = document.getElementById("shortRect");
      var y = document.getElementById("longRect");

      if (x.style.display === "none") { // turn short rectangle on
          x.style.display = "block";
          y.style.display = "none";
      } else {                          // turn long rectangle on
          x.style.display = "none";
          y.style.display = "block";
      }
  }

  document.getElementById('changeRect').addEventListener('click', function () {
    toggleRectangle();
    socket.emit('changeSize', {'activeRectangle':getActiveRect().id})
  });
  document.getElementById('projectButton').addEventListener('click', function () {
    project();
  });


  function project(){
    var stage = getActiveRect(), // Get the canvas element by Id
          ctx = stage.getContext('2d'), // Canvas 2d rendering context
          x = 0, //intial horizontal position of drawn rectangle
          y = 0, //intial vertical position of drawn rectangle
          wid = stage.height, //width of the drawn rectangle
          hei = stage.height; //height of the drawn rectangle

    //Draw Rectangle function
    function drawRect(x,y,wid,hei) {
        ctx.fillStyle = '#666'; // Fill color of rectangle drawn
        ctx.fillRect(x, y, wid, hei);
    }
    ctx.clearRect(0,0, 500, 500);
    drawRect(x,y,wid,hei); //Drawing rectangle on initial load
    //move rectangle inside the canvas using arrow keys
    window.onkeydown = function(event) {
        var keyPr = event.keyCode; //Key code of key pressed

        if(keyPr === 39 && x<=140){
            x = x+10; //right arrow add 20 from current
        } else if(keyPr === 37 && x>5){
            x = x-10; //left arrow subtract 20 from current
        }

        /*clearing anything drawn on canvas
         *comment this below do draw path */
        ctx.clearRect(0,0, 500, 500);
        //Drawing rectangle at new position
        drawRect(x,y,wid,hei);
    };
  }

  map.on('load', function () {
      // beltline layer
      map.addSource('beltline', {
          type: 'vector',
          url: 'mapbox://modernlovelace.9bd0nhcf'
      });
      map.addLayer({
          'id': 'beltline',
          'type': 'line',
          'source': 'beltline',
          'source-layer': 'Beltline_Weave-a4j3wv',
          'layout': {
              'visibility': 'visible',
              'line-join': 'round',
              'line-cap': 'round'
          },
          'paint': {
              'line-color': 'yellow green',
              'line-width': 8
          }
      });
      // tax layer
      map.addSource('Tax Assessment', {
          type: 'vector',
          url: 'mapbox://annabelrothschild.4lnspuic'
      });
      map.addLayer({ 
          'id': 'place-highlight',
          'type': 'circle', 
          'source': 'Tax Assessment',
          'source-layer': 'AllPointsGeoJSON-12eyog',
          'paint': {
            'circle-color': '#FADA5E',
            'circle-radius': 20,
            'circle-opacity': .5,
          },
          'filter': ['==', 'ID', -1]
      });
      map.addLayer({
          'id': 'Tax Assessment',
          'type': 'circle',
          'source': 'Tax Assessment',
          'interactive': true,
          "layout": {
                    "text-font": "Open Sans Semibold, Arial Unicode MS Bold",
                    "text-offset": [0, 0.6],
                    "text-anchor": "top"
                  },
          'layout': {
              'visibility': 'none'
          },
          'paint': {
              'circle-radius': 3,
              'circle-color': [
                  "rgb",
                  ["get", "Red"],
                  ["get", "Green"],
                  ["get", "Blue"]
              ]
          },
          'source-layer': 'AllPointsGeoJSON-12eyog'
      });
  });

  map.on('moveend', function (e) {
        console.log("Sending change to server...");
        socket.emit('locUpdate', {'center': map.getCenter(), 'zoom': map.getZoom(), 'bearing':map.getBearing()});
        socket.emit("reQueryFeatures", {'features':map.queryRenderedFeatures({layers:['Tax Assessment']})});
  });

  // link layers to buttons
  var toggleableLayerIds = [ 'Tax Assessment' ];

  for (var i = 0; i < toggleableLayerIds.length; i++) {
      var id = toggleableLayerIds[i];

      var link = document.createElement('a');
      link.href = '#';
      //link.className = 'active';
      link.textContent = id;

      link.onclick = function (e) {
          var clickedLayer = this.textContent;
          e.preventDefault();
          e.stopPropagation();

          var visibility = map.getLayoutProperty(clickedLayer, 'visibility');
          if (visibility === 'visible') {
              map.setLayoutProperty(clickedLayer, 'visibility', 'none');
              socket.emit('hideLayer', {'clickedLayer':clickedLayer})
              this.className = '';
          } else {
              this.className = 'active';
              map.setLayoutProperty(clickedLayer, 'visibility', 'visible');
              socket.emit('showLayer', {'clickedLayer':clickedLayer})
          }
      };

      var layers = document.getElementById('menu');
      layers.appendChild(link);
  }

  </script>
</body>
</html>
